<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>龍科廠-公共危險物品儲存量管理系統</title>
    
    <!-- 引入 React 和 Tailwind CSS -->
    <script src="https://unpkg.com/react@18/umd/react.development.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js" crossorigin></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- 引入 Chart.js 用於繪製趨勢圖 -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <!-- 設定 Tailwind -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        slate: {
                            50: '#f8fafc', 100: '#f1f5f9', 200: '#e2e8f0', 300: '#cbd5e1',
                            400: '#94a3b8', 500: '#64748b', 600: '#475569', 700: '#334155',
                            800: '#1e293b', 900: '#0f172a',
                        }
                    }
                }
            }
        }
    </script>
    <style>
        .table-bordered td, .table-bordered th {
            border: 1px solid #e2e8f0 !important;
        }
        .table-header-border th {
             border: 1px solid #94a3b8 !important;
        }
    </style>
</head>
<body class="bg-slate-50 text-slate-800">
    <div id="root"></div>

    <!-- Firebase SDK (Module) -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, deleteDoc, updateDoc, doc, onSnapshot, query, orderBy } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // 嘗試取得環境變數中的 Firebase 設定
        const firebaseConfigStr = typeof __firebase_config !== 'undefined' ? __firebase_config : null;
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app';
        const initialToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        if (firebaseConfigStr) {
            try {
                const app = initializeApp(JSON.parse(firebaseConfigStr));
                const auth = getAuth(app);
                const db = getFirestore(app);
                
                window.firebaseServices = {
                    auth,
                    db,
                    signInAnonymously,
                    signInWithCustomToken,
                    onAuthStateChanged,
                    collection,
                    addDoc,
                    deleteDoc,
                    updateDoc, 
                    doc,
                    onSnapshot,
                    query,
                    orderBy,
                    appId,
                    initialToken
                };
                console.log("Firebase 模式啟動");
            } catch (e) {
                console.error("Firebase 初始化失敗:", e);
            }
        } else {
            console.log("未偵測到 Firebase 設定，將使用 LocalStorage 模式");
        }
    </script>

    <script type="text/babel">
        const { useState, useMemo, useEffect, useRef } = React;

        // --- 圖示元件 ---
        const Icon = ({ path, color = "currentColor", size = 24, className = "" }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke={color} strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>
                {path}
            </svg>
        );

        const Save = (props) => <Icon {...props} path={<><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"/><polyline points="17 21 17 13 7 13 7 21"/><polyline points="7 3 7 8 15 8"/></>} />;
        const Trash2 = (props) => <Icon {...props} path={<><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/><line x1="10" y1="11" x2="10" y2="17"/><line x1="14" y1="11" x2="14" y2="17"/></>} />;
        const Edit = (props) => <Icon {...props} path={<><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/></>} />;
        const Download = (props) => <Icon {...props} path={<><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></>} />;
        const Upload = (props) => <Icon {...props} path={<><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/></>} />;
        const Filter = (props) => <Icon {...props} path={<><polygon points="22 3 2 3 10 12.46 10 19 14 21 14 12.46 22 3"/></>} />;
        const FileSpreadsheet = (props) => <Icon {...props} path={<><path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z"/><polyline points="14 2 14 8 20 8"/><path d="M8 13h2"/><path d="M8 17h2"/><path d="M14 13h2"/><path d="M14 17h2"/></>} />;
        const PlusCircle = (props) => <Icon {...props} path={<><circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="16"/><line x1="8" y1="12" x2="16" y2="12"/></>} />;
        const AlertTriangle = (props) => <Icon {...props} path={<><path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"/><line x1="12" y1="9" x2="12" y2="13"/><line x1="12" y1="17" x2="12.01" y2="17"/></>} />;
        const CheckCircle = (props) => <Icon {...props} path={<><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/></>} />;
        const AlertCircle = (props) => <Icon {...props} path={<><circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="12"/><line x1="12" y1="16" x2="12.01" y2="16"/></>} />;
        const XIcon = (props) => <Icon {...props} path={<><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></>} />;
        const Search = (props) => <Icon {...props} path={<><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></>} />;
        const CalendarIcon = (props) => <Icon {...props} path={<><rect x="3" y="4" width="18" height="18" rx="2" ry="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></>} />;
        const MapPin = (props) => <Icon {...props} path={<><path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"/><circle cx="12" cy="10" r="3"/></>} />;
        const TrendingUp = (props) => <Icon {...props} path={<><polyline points="23 6 13.5 15.5 8.5 10.5 1 18"/><polyline points="17 6 23 6 23 12"/></>} />;
        const Tag = (props) => <Icon {...props} path={<><path d="M20.59 13.41l-7.17 7.17a2 2 0 0 1-2.83 0L2 12V2h10l8.59 8.59a2 2 0 0 1 0 2.82z"/><line x1="7" y1="7" x2="7.01" y2="7"/></>} />;
        const ShieldAlert = (props) => <Icon {...props} path={<><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/><line x1="12" y1="8" x2="12" y2="12"/><line x1="12" y1="16" x2="12.01" y2="16"/></>} />;
        const Cloud = (props) => <Icon {...props} path={<><path d="M18 10h-1.26A8 8 0 1 0 9 20h9a5 5 0 0 0 0-10z"/></>} />;
        const Database = (props) => <Icon {...props} path={<><ellipse cx="12" cy="5" rx="9" ry="3"/><path d="M21 12c0 1.66-4 3-9 3s-9-1.34-9-3"/><path d="M3 5v14c0 1.66 4 3 9 3s9-1.34 9-3V5"/></>} />;
        const Info = (props) => <Icon {...props} path={<><circle cx="12" cy="12" r="10"/><line x1="12" y1="16" x2="12" y2="12"/><line x1="12" y1="8" x2="12.01" y2="8"/></>} />;
        const ChevronDown = (props) => <Icon {...props} path={<><polyline points="6 9 12 15 18 9"/></>} />;
        const Lock = (props) => <Icon {...props} path={<><rect x="3" y="11" width="18" height="11" rx="2" ry="2"/><path d="M7 11V7a5 5 0 0 1 10 0v4"/></>} />;
        const Unlock = (props) => <Icon {...props} path={<><rect x="3" y="11" width="18" height="11" rx="2" ry="2"/><path d="M7 11V7a5 5 0 0 1 9.9-1"/></>} />;

        // --- 可搜尋下拉選單元件 (通用) ---
        const SearchableSelect = ({ value, onChange, options, placeholder, icon: IconComp }) => {
            const [isOpen, setIsOpen] = useState(false);
            const [inputValue, setInputValue] = useState(value);
            const wrapperRef = useRef(null);

            useEffect(() => {
                setInputValue(value);
            }, [value]);

            useEffect(() => {
                const handleClickOutside = (event) => {
                    if (wrapperRef.current && !wrapperRef.current.contains(event.target)) {
                        setIsOpen(false);
                    }
                };
                document.addEventListener("mousedown", handleClickOutside);
                return () => document.removeEventListener("mousedown", handleClickOutside);
            }, [wrapperRef]);

            const filteredOptions = options.filter(opt => 
                opt.toLowerCase().includes((inputValue || "").toLowerCase())
            );

            return (
                <div className="relative w-full" ref={wrapperRef}>
                    {IconComp && <IconComp className="absolute left-3 top-2.5 text-slate-400" size={18} />}
                    <input
                        type="text"
                        value={inputValue}
                        onChange={(e) => {
                            setInputValue(e.target.value);
                            onChange(e.target.value); 
                            setIsOpen(true);
                        }}
                        onFocus={() => setIsOpen(true)}
                        placeholder={placeholder}
                        className={`w-full p-2 text-sm border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 bg-white ${IconComp ? 'pl-10' : 'pl-3'}`}
                        autoComplete="off"
                    />
                    <button
                        type="button"
                        onClick={() => setIsOpen(!isOpen)}
                        className="absolute right-2 top-2.5 text-slate-400 hover:text-slate-600"
                    >
                        <ChevronDown size={16} />
                    </button>

                    {isOpen && (
                        <ul className="absolute z-10 w-full bg-white border border-slate-300 rounded-lg shadow-lg max-h-60 overflow-y-auto mt-1">
                            <li 
                                className="p-2 text-sm hover:bg-blue-50 cursor-pointer transition-colors text-slate-400 italic"
                                onMouseDown={() => {
                                    setInputValue("");
                                    onChange("");
                                    setIsOpen(false);
                                }}
                            >
                                -- 全部 / 清除 --
                            </li>
                            {filteredOptions.length > 0 ? (
                                filteredOptions.map(opt => (
                                    <li
                                        key={opt}
                                        className="p-2 text-sm hover:bg-blue-50 cursor-pointer transition-colors"
                                        onMouseDown={() => {
                                            setInputValue(opt);
                                            onChange(opt);
                                            setIsOpen(false);
                                        }}
                                    >
                                        {opt}
                                    </li>
                                ))
                            ) : (
                                <li className="p-2 text-sm text-slate-400 text-center">無符合項目</li>
                            )}
                        </ul>
                    )}
                </div>
            );
        };

        // ... (WEREHOUSE_STATS_CONFIG, L30_STATS_CONFIG, CHEMICAL_DB, CHEMICAL_LIST, STORAGE_LOCATIONS 保持不變)
        // --- 固定式合法申請量設定 - 危險品庫房 ---
        const WAREHOUSE_STATS_CONFIG = [
            {
                type: "第一石油類",
                items: [
                    { name: "添加劑", limit: 7769.00, statLimit: 200 },
                    { name: "乙酸乙酯", limit: 7920.00, statLimit: 200 },
                    { name: "丁酮", limit: 660.00, statLimit: 200 },
                    { name: "乙酸正丙酯(NPA)", limit: 720.00, statLimit: 200 },
                    { name: "C0301廢棄物(第一石油類)", limit: 9600.00, statLimit: 200 }
                ]
            },
            {
                type: "第二石油類",
                items: [
                    { name: "丙二醇甲醚", limit: 1520.00, statLimit: 1000 },
                    { name: "乙酸正丁酯", limit: 7200.00, statLimit: 1000 },
                    { name: "丙二醇甲醚醋酸酯", limit: 600.00, statLimit: 1000 },
                    { name: "正丁醇", limit: 1650.00, statLimit: 1000 },
                    { name: "添加劑", limit: 6203.00, statLimit: 1000 },
                    { name: "感壓膠", limit: 33480.00, statLimit: 1000 },
                    { name: "C0301廢棄物(第二石油類)", limit: 16000.00, statLimit: 1000 }
                ]
            },
            {
                type: "第三石油類",
                items: [
                    { name: "添加劑", limit: 113.00, statLimit: 2000 },
                    { name: "UV感壓膠", limit: 0, statLimit: 2000 }
                ]
            }
        ];

        // --- 固定式合法申請量設定 - L30原膠室(C4+P1) ---
        const L30_STATS_CONFIG = [
            {
                type: "第一石油類",
                items: [
                    { name: "乙酸乙酯", limit: 2818.00, statLimit: 200 },
                    { name: "添加劑", limit: 83.00, statLimit: 200 }
                ]
            },
            {
                type: "第二石油類",
                items: [
                    { name: "乙酸正丁酯", limit: 720.00, statLimit: 1000 }, 
                    { name: "丙二醇甲醚醋酸酯", limit: 760.00, statLimit: 1000 },
                    { name: "添加劑", limit: 47.00, statLimit: 1000 },
                    { name: "感壓膠", limit: 24370.00, statLimit: 1000 }
                ]
            },
            {
                type: "第三石油類",
                items: [
                    { name: "添加劑", limit: 11.00, statLimit: 2000 }
                ]
            },
            {
                type: "酒精類",
                items: [
                    { name: "異丙醇", limit: 320.00, statLimit: 400 }
                ]
            }
        ];

        // --- 化學品詳細資料庫 ---
        const CHEMICAL_DB = {
            "IPA(異丙醇)": { labelCategory: "異丙醇", partNo: "XS.02012.003", hazard: "第四類 易燃液體", type: "酒精類", solubility: "NA", limit: 400, flashPoint: 12.00 },
            "乙酸乙酯(Ethyl Acetate)": { labelCategory: "乙酸乙酯", partNo: "36.10004.000", hazard: "第四類 易燃液體", type: "第一石油類", solubility: "非水溶性", limit: 200, flashPoint: -4.40 },
            "丙二醇甲醚 Propylene glycol monomethyl ether": { labelCategory: "丙二醇甲醚", partNo: "", hazard: "第四類 易燃液體", type: "第二石油類", solubility: "非水溶性", limit: 1000, flashPoint: 32.00 },
            "乙酸正丁酯(n-Butyl acetate)": { labelCategory: "乙酸正丁酯", partNo: "36.10012.010", hazard: "第四類 易燃液體", type: "第二石油類", solubility: "非水溶性", limit: 1000, flashPoint: 22.00 },
            "丁酮 (Methyl ethyl ketone)": { labelCategory: "丁酮", partNo: "", hazard: "第四類 易燃液體", type: "第一石油類", solubility: "非水溶性", limit: 200, flashPoint: -9.00 },
            "丙二醇甲醚醋酸酯（Propylene glycol monomethyl ether acetate）": { labelCategory: "丙二醇甲醚醋酸酯", partNo: "", hazard: "第四類 易燃液體", type: "第二石油類", solubility: "非水溶性", limit: 1000, flashPoint: 42.00 },
            "正丁醇(Butyl alcohol)": { labelCategory: "正丁醇", partNo: "", hazard: "第四類 易燃液體", type: "第二石油類", solubility: "非水溶性", limit: 1000, flashPoint: 29.00 },
            "乙酸正丙酯 (n-Propyl acetcate)": { labelCategory: "乙酸正丙酯(NPA)", partNo: "", hazard: "第四類 易燃液體", type: "第一石油類", solubility: "非水溶性", limit: 1000, flashPoint: 10.00 },
            "感壓膠- RE03312": { labelCategory: "感壓膠", partNo: "36.13019.003", hazard: "第四類 易燃液體", type: "第二石油類", solubility: "非水溶性", limit: 1000, flashPoint: 31.00 },
            "壓敏粘合劑-SAIVINOL AT-392": { labelCategory: "添加劑", partNo: "36.13034.000", hazard: "第四類 易燃液體", type: "第一石油類", solubility: "非水溶性", limit: 200, flashPoint: -10.00 },
            "壓敏粘合劑-SAIVINOL PL-7930": { labelCategory: "添加劑", partNo: "36.13043.000", hazard: "第四類 易燃液體", type: "第一石油類", solubility: "非水溶性", limit: 200, flashPoint: -10.00 },
            "壓敏粘合劑-SAIVINOL PL-0528": { labelCategory: "添加劑", partNo: "36.13051.000", hazard: "第四類 易燃液體", type: "第一石油類", solubility: "非水溶性", limit: 200, flashPoint: -10.00 },
            "感壓膠(RE03038)": { labelCategory: "感壓膠", partNo: "36.13060.000", hazard: "第四類 易燃液體", type: "第二石油類", solubility: "非水溶性", limit: 1000, flashPoint: 31.00 },
            "壓敏粘合劑-SAIVINOL PL-7701": { labelCategory: "添加劑", partNo: "36.13061.000", hazard: "第四類 易燃液體", type: "第一石油類", solubility: "非水溶性", limit: 200, flashPoint: -10.00 },
            "固化劑-SAIVINOL HARDENER AL": { labelCategory: "添加劑", partNo: "36.14011.000", hazard: "第四類 易燃液體", type: "第一石油類", solubility: "非水溶性", limit: 200, flashPoint: -5.00 },
            "固化劑-AD75": { labelCategory: "添加劑", partNo: "36.14012.000", hazard: "第四類 易燃液體", type: "第二石油類", solubility: "非水溶性", limit: 1000, flashPoint: 53.00 },
            "CA-190T": { labelCategory: "添加劑", partNo: "36.14013.000", hazard: "第四類 易燃液體", type: "第一石油類", solubility: "非水溶性", limit: 200, flashPoint: 4.00 },
            "硬化劑-HE-3110": { labelCategory: "添加劑", partNo: "36.14015.010", hazard: "第四類 易燃液體", type: "第一石油類", solubility: "非水溶性", limit: 200, flashPoint: -4.40 },
            "HE3110": { labelCategory: "添加劑", partNo: "", hazard: "第四類 易燃液體", type: "第一石油類", solubility: "非水溶性", limit: 200, flashPoint: -4.40 },
            "固化劑-SAIVINOL HARDENER M-2": { labelCategory: "添加劑", partNo: "36.14016.000", hazard: "第四類 易燃液體", type: "第一石油類", solubility: "非水溶性", limit: 5.00 },
            "固化劑-SAIVINOL HARDENER K-904B": { labelCategory: "添加劑", partNo: "36.14027.000", hazard: "第四類 易燃液體", type: "第二石油類", solubility: "非水溶性", limit: 1000, flashPoint: 27.50 },
            "TAKENATETM D-262": { labelCategory: "添加劑", partNo: "36.14030.000", hazard: "第四類 易燃液體", type: "第二石油類", solubility: "非水溶性", limit: 1000, flashPoint: 29.20 },
            "固化劑-SAIVINOL HARDENER K-901": { labelCategory: "添加劑", partNo: "36.14031.000", hazard: "第四類 易燃液體", type: "第一石油類", solubility: "非水溶性", limit: 200, flashPoint: -4.00 },
            "XIAMETER™ OFS-6030 矽烷": { labelCategory: "添加劑", partNo: "36.15003.000", hazard: "第四類 易燃液體", type: "第三石油類", solubility: "非水溶性", limit: 2000, flashPoint: 100.00 },
            "矽烷偶合劑-SAIVINOL ADDITIVE S-1": { labelCategory: "添加劑", partNo: "36.15009.000", hazard: "第四類 易燃液體", type: "第一石油類", solubility: "非水溶性", limit: 200, flashPoint: 5.00 },
            "KR-519": { labelCategory: "添加劑", partNo: "36.15016.000", hazard: "第四類 易燃液體", type: "第二石油類", solubility: "非水溶性", limit: 1000, flashPoint: 24.00 },
            "KBM-803": { labelCategory: "添加劑", partNo: "36.15017.000", hazard: "第四類 易燃液體", type: "第三石油類", solubility: "非水溶性", limit: 2000, flashPoint: 85.00 },
            "KBM-503": { labelCategory: "添加劑", partNo: "36.15020.000", hazard: "第四類 易燃液體", type: "第三石油類", solubility: "非水溶性", limit: 2000, flashPoint: 112.00 },
            "KBM-402": { labelCategory: "添加劑", partNo: "36.15021.000", hazard: "第四類 易燃液體", type: "第三石油類", solubility: "非水溶性", limit: 2000, flashPoint: 94.00 },
            "矽烷偶合劑-SAIVINOL ADDITIVE S-775B": { labelCategory: "添加劑", partNo: "36.15044.000", hazard: "第四類 易燃液體", type: "第一石油類", solubility: "非水溶性", limit: 200, flashPoint: -5.00 },
            "GRANDIC PC 8800FT": { labelCategory: "添加劑", partNo: "36.16404.000", hazard: "第四類 易燃液體", type: "第一石油類", solubility: "非水溶性", limit: 200, flashPoint: -4.00 },
            "GRANDIC PC 8900FT": { labelCategory: "添加劑", partNo: "36.16404.002", hazard: "第四類 易燃液體", type: "第一石油類", solubility: "非水溶性", limit: 200, flashPoint: -5.60 },
            "GRANDIC PC 6191FT": { labelCategory: "添加劑", partNo: "36.16404.003", hazard: "第四類 易燃液體", type: "第一石油類", solubility: "非水溶性", limit: 200, flashPoint: -4.00 },
            "DX-690I": { labelCategory: "添加劑", partNo: "36.16404.012", hazard: "第四類 易燃液體", type: "第一石油類", solubility: "非水溶性", limit: 200, flashPoint: -4.00 },
            "GRANDIC PC 8100FT": { labelCategory: "添加劑", partNo: "36.16404.071", hazard: "第四類 易燃液體", type: "第一石油類", solubility: "非水溶性", limit: 200, flashPoint: -4.00 },
            "HC6222-001": { labelCategory: "感壓膠", partNo: "36.16404.075", hazard: "第四類 易燃液體", type: "第二石油類", solubility: "非水溶性", limit: 1000, flashPoint: 40.00 },
            "HC6224": { labelCategory: "感壓膠", partNo: "", hazard: "第四類 易燃液體", type: "第二石油類", solubility: "非水溶性", limit: 1000, flashPoint: 40.00 },
            "HC6229-006": { labelCategory: "感壓膠", partNo: "36.16404.075", hazard: "第四類 易燃液體", type: "第二石油類", solubility: "非水溶性", limit: 1000, flashPoint: 40.00 },
            "GRANDIC PC 4100T": { labelCategory: "添加劑", partNo: "36.17000.020", hazard: "第四類 易燃液體", type: "第一石油類", solubility: "非水溶性", limit: 200, flashPoint: -4.00 },
            "GRANDIC PC 4900LT": { labelCategory: "添加劑", partNo: "36.17000.022", hazard: "第四類 易燃液體", type: "第一石油類", solubility: "非水溶性", limit: 200, flashPoint: -4.00 },
            "UV 接著膠-UVAP02": { labelCategory: "UV感壓膠", partNo: "36.32857.000", hazard: "第四類 易燃液體", type: "第三石油類", solubility: "非水溶性", limit: 2000, flashPoint: -4.40 },
            "UV 接著膠-UVAT01": { labelCategory: "UV感壓膠", partNo: "36.32859.000", hazard: "第四類 易燃液體", type: "第三石油類", solubility: "非水溶性", limit: 2000, flashPoint: -4.40 },
            "HC6 224 004": { labelCategory: "感壓膠", partNo: "", hazard: "第四類 易燃液體", type: "第二石油類", solubility: "非水溶性", limit: 1000, flashPoint: 40.00 },
            "HC6229-006": { labelCategory: "感壓膠", partNo: "", hazard: "第四類 易燃液體", type: "第二石油類", solubility: "非水溶性", limit: 1000, flashPoint: 40.00 },
            "润湿分散剂-DISPERBYK-2150": { labelCategory: "添加劑", partNo: "", hazard: "第四類 易燃液體", type: "第三石油類", solubility: "非水溶性", limit: 2000, flashPoint: 100.00 },
            "NANOBYK-3650": { labelCategory: "添加劑", partNo: "", hazard: "第四類 易燃液體", type: "第三石油類", solubility: "非水溶性", limit: 2000, flashPoint: 100.00 },
            "MEK ST UP 溶劑型矽酸膠": { labelCategory: "添加劑", partNo: "", hazard: "第四類 易燃液體", type: "第一石油類", solubility: "非水溶性", limit: 200, flashPoint: -9.00 },
            "PSA廢膠": { labelCategory: "感壓膠", partNo: "", hazard: "第四類 易燃液體", type: "第二石油類", solubility: "非水溶性", limit: 1000, flashPoint: 40.00 },
            "C0301廢棄物(第一石油類)": { labelCategory: "C0301廢棄物(第一石油類)", partNo: "", hazard: "第四類 易燃液體", type: "第一石油類", solubility: "非水溶性", limit: 200, flashPoint: 4.40 },
            "C0301廢棄物(第二石油類)": { labelCategory: "C0301廢棄物(第二石油類)", partNo: "", hazard: "第四類 易燃液體", type: "第二石油類", solubility: "非水溶性", limit: 1000, flashPoint: 40.00 },
        };

        const CHEMICAL_LIST = Object.keys(CHEMICAL_DB);

        // --- 儲存場所列表 ---
        const STORAGE_LOCATIONS = [
            "危險品庫房",
            "C4原膠室",
            "P1原膠室"
        ];

        // --- 趨勢圖元件 ---
        const TrendChart = ({ data, title }) => {
            const chartRef = useRef(null);
            const chartInstance = useRef(null);

            // 整理數據：依照日期與化學品分組
            const chartData = useMemo(() => {
                const allDates = [...new Set(data.map(item => item.date))].sort();
                const chemicals = [...new Set(data.map(item => item.chemical))];

                const datasets = chemicals.map((chem, index) => {
                    const chemData = allDates.map(date => {
                        const records = data.filter(r => r.date === date && r.chemical === chem);
                        return records.reduce((sum, r) => sum + r.amount, 0);
                    });

                    const hue = (index * 137.508) % 360; 
                    const color = `hsla(${hue}, 70%, 50%, 1)`;
                    const bg = `hsla(${hue}, 70%, 50%, 0.1)`;

                    return {
                        label: chem,
                        data: chemData,
                        borderColor: color,
                        backgroundColor: bg,
                        borderWidth: 2,
                        tension: 0.3,
                        fill: false,
                        pointRadius: 4,
                        pointHoverRadius: 6
                    };
                });

                return {
                    labels: allDates,
                    datasets: datasets
                };
            }, [data]);

            useEffect(() => {
                if (chartRef.current) {
                    if (chartInstance.current) {
                        chartInstance.current.destroy();
                    }

                    const ctx = chartRef.current.getContext('2d');
                    
                    chartInstance.current = new Chart(ctx, {
                        type: 'line',
                        data: chartData,
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            interaction: {
                                mode: 'index',
                                intersect: false,
                            },
                            plugins: {
                                legend: {
                                    position: 'top',
                                    align: 'start',
                                    labels: {
                                        boxWidth: 12,
                                        usePointStyle: true,
                                        font: {
                                            size: 11
                                        }
                                    }
                                },
                                tooltip: {
                                    backgroundColor: 'rgba(255, 255, 255, 0.95)',
                                    titleColor: '#1e293b',
                                    bodyColor: '#475569',
                                    borderColor: '#e2e8f0',
                                    borderWidth: 1,
                                    padding: 10,
                                    boxPadding: 4
                                }
                            },
                            scales: {
                                y: {
                                    beginAtZero: true,
                                    title: {
                                        display: true,
                                        text: '儲存量 (kg/L)'
                                    },
                                    grid: { color: '#f1f5f9' },
                                    ticks: { color: '#64748b' }
                                },
                                x: {
                                    grid: { display: false },
                                    ticks: { color: '#64748b' }
                                }
                            }
                        }
                    });
                }

                return () => {
                    if (chartInstance.current) {
                        chartInstance.current.destroy();
                    }
                };
            }, [chartData]);

            if (data.length === 0) return null;

            return (
                <div className="bg-white rounded-xl shadow-sm p-5 border border-slate-200 h-96 mt-6">
                    <h3 className="text-lg font-bold text-slate-700 mb-4 flex items-center gap-2">
                        <TrendingUp size={20} className="text-blue-500" />
                        {title || '化學品儲存量趨勢'}
                    </h3>
                    <div className="h-80">
                        <canvas ref={chartRef}></canvas>
                    </div>
                </div>
            );
        };

        // --- 區域符合度表格元件 (使用固定配置) ---
        const ZoneComplianceTable = ({ title, records, config, stats }) => {
            
            const tableData = useMemo(() => {
                const actualsMap = {};
                // 需要依照 type + labelCategory 來對應，避免不同類別同名稱 (如: 添加劑) 混淆
                records.forEach(r => {
                    // 根據 CHEMICAL_DB 的 type 與 labelCategory 進行歸類
                    // key 格式: "第一石油類_添加劑"
                    const key = `${r.type}_${r.labelCategory}`;
                    if (!actualsMap[key]) actualsMap[key] = 0;
                    actualsMap[key] += r.amount;
                });

                return config.map(typeGroup => {
                    let typeGroupTotalApp = 0;
                    let typeGroupTotalLegalRatio = 0;
                    let typeGroupActualTotalRatio = 0;
                    let typeGroupTotalActual = 0; 

                    const subRows = typeGroup.items.map(item => {
                        const appAmount = item.limit; 
                        const statLimit = item.statLimit; 
                        
                        const legalRatio = statLimit > 0 ? (appAmount / statLimit) : 0;

                        // 使用 type + name 進行查找
                        const lookupKey = `${typeGroup.type}_${item.name}`;
                        const actualAmount = actualsMap[lookupKey] || 0;
                        
                        const actualRatio = statLimit > 0 ? (actualAmount / statLimit) : 0;

                        let excessAmount = 0;
                        if (appAmount === 0 && actualAmount > 0) {
                            excessAmount = actualAmount; 
                        } else if (actualAmount > appAmount) {
                            excessAmount = actualAmount - appAmount;
                        }

                        typeGroupTotalApp += appAmount;
                        typeGroupTotalLegalRatio += legalRatio;
                        typeGroupActualTotalRatio += actualRatio;
                        typeGroupTotalActual += actualAmount;

                        return {
                            name: item.name,
                            limit: appAmount,
                            legalRatio: legalRatio,
                            actualAmount: actualAmount,
                            excess: excessAmount,
                            actualRatio: actualRatio,
                            isUnapplied: appAmount === 0
                        };
                    });

                    // Compliance Ratio: Sum(Actual) / Sum(App)
                    // If Sum(App) is 0, but there is actual amount, ratio is Infinity (or considered over limit)
                    // If Sum(App) is 0 and actual is 0, ratio is 0 (compliant)
                    const totalComplianceRatio = typeGroupTotalApp > 0 
                        ? (typeGroupTotalActual / typeGroupTotalApp) 
                        : (typeGroupTotalActual > 0 ? Infinity : 0);

                    return {
                        type: typeGroup.type,
                        totalApp: typeGroupTotalApp,
                        totalLegalRatio: typeGroupTotalLegalRatio,
                        actualTotalRatio: typeGroupActualTotalRatio, 
                        totalComplianceRatio: totalComplianceRatio, 
                        subRows: subRows
                    };
                });
            }, [records, config]);

            // Calculate zone-wide stats within the component to match Table logic
            const zoneSummary = useMemo(() => {
                 let totalRatio = 0;
                 let totalAmount = records.reduce((sum, r) => sum + r.amount, 0);

                 // Recalculate ratio based on actual logic in App
                 const actualsMap = {};
                 records.forEach(r => {
                     const key = `${r.type}_${r.labelCategory}`;
                     if (!actualsMap[key]) actualsMap[key] = 0;
                     actualsMap[key] += r.amount;
                 });

                 config.forEach(typeGroup => {
                     typeGroup.items.forEach(item => {
                        const statLimit = item.statLimit; 
                        const lookupKey = `${typeGroup.type}_${item.name}`;
                        const actualAmount = actualsMap[lookupKey] || 0;
                        const ratio = statLimit > 0 ? (actualAmount / statLimit) : 0;
                        totalRatio += ratio;
                    });
                 });
                 return { totalRatio, totalAmount };
            }, [records, config]);


            if (records.length === 0) return null;

            return (
                <div className="bg-white rounded-xl shadow-sm p-5 border border-slate-200 mt-6 overflow-hidden">
                    <div className="flex flex-col md:flex-row justify-between items-start md:items-center mb-4 gap-4">
                        <h3 className="text-lg font-bold text-slate-700 flex items-center gap-2">
                            <AlertTriangle size={20} className="text-orange-400" />
                            {title} - 區域管制量檢核
                        </h3>
                        <div className="flex items-center gap-3 text-sm">
                            <div className="px-3 py-1 rounded bg-orange-50 border border-orange-200 shadow-sm">
                                <span className="text-orange-800 font-medium mr-1">倍數:</span>
                                <span className={`font-bold ${zoneSummary.totalRatio >= 30 ? 'text-red-600' : 'text-blue-600'}`}>
                                    {zoneSummary.totalRatio.toFixed(2)}
                                </span>
                            </div>
                            <div className="px-3 py-1 rounded bg-sky-50 border border-sky-200 shadow-sm">
                                <span className="text-sky-800 font-medium mr-1">儲存量:</span>
                                <span className="font-bold text-blue-600">
                                    {zoneSummary.totalAmount.toFixed(2)}
                                </span>
                            </div>
                        </div>
                    </div>
                    <div className="overflow-x-auto">
                        <table className="w-full text-center border-collapse table-bordered table-header-border text-sm">
                            <thead>
                                <tr>
                                    <th className="bg-indigo-500 text-white p-2 w-24">危物種類</th>
                                    <th colSpan="5" className="bg-amber-100 text-amber-900 p-2 border-b border-slate-400 font-bold">合法申請量(標示版)</th>
                                    <th colSpan="3" className="bg-orange-100 text-orange-900 p-2 border-b border-slate-400 font-bold">實際儲存及符合度-By 化學品分類</th>
                                    <th className="bg-emerald-100 text-emerald-900 p-2 w-32 font-bold">實際儲存及符合度-by 總量</th>
                                </tr>
                                <tr className="text-xs">
                                    <th className="bg-indigo-500 text-white p-2"></th> 
                                    <th className="bg-amber-50 p-2 text-amber-900">化學品分類</th>
                                    <th className="bg-amber-50 p-2 text-amber-900">申請量</th>
                                    <th className="bg-amber-50 p-2 text-amber-900">申請量加總</th>
                                    <th className="bg-amber-50 p-2 text-amber-900">倍數</th>
                                    <th className="bg-amber-50 p-2 text-amber-900">倍數加總</th>
                                    
                                    <th className="bg-orange-50 p-2 text-orange-900">實際儲存量</th>
                                    <th className="bg-orange-50 p-2 text-orange-900">超標量</th>
                                    <th className="bg-orange-50 p-2 text-orange-900">符合度</th>
                                    
                                    <th className="bg-emerald-50 p-2 text-emerald-900"></th> 
                                </tr>
                            </thead>
                            <tbody>
                                {tableData.map((typeGroup) => {
                                    return typeGroup.subRows.map((sub, subIndex) => {
                                        const isFirst = subIndex === 0;
                                        const isExcess = sub.excess > 0;
                                        const isUnapplied = sub.isUnapplied;
                                        const isTypeOverLimit = typeGroup.totalComplianceRatio > 1;

                                        return (
                                            <tr key={`${typeGroup.type}-${sub.name}`} className="hover:bg-slate-50">
                                                {isFirst && (
                                                    <td rowSpan={typeGroup.subRows.length} className="bg-indigo-600 text-white font-bold align-middle p-2 text-xs border-r border-slate-300">
                                                        {typeGroup.type}
                                                    </td>
                                                )}

                                                <td className="p-2 bg-white text-xs text-slate-700">{sub.name}</td>
                                                <td className="p-2 bg-white text-slate-600">
                                                    {isUnapplied ? "未申請" : sub.limit.toLocaleString()}
                                                </td>
                                                
                                                {isFirst && (
                                                    <td rowSpan={typeGroup.subRows.length} className="p-2 bg-white align-middle font-medium text-slate-700">
                                                        {typeGroup.totalApp.toLocaleString()}
                                                    </td>
                                                )}

                                                <td className="p-2 bg-white text-slate-600">
                                                    {isUnapplied ? "未申請" : sub.legalRatio.toFixed(2)}
                                                </td>

                                                {isFirst && (
                                                    <td rowSpan={typeGroup.subRows.length} className="p-2 bg-white align-middle font-medium text-slate-700 border-r border-slate-200">
                                                        {typeGroup.totalLegalRatio.toFixed(2)}
                                                    </td>
                                                )}

                                                <td className="p-2 bg-white font-bold text-slate-700">
                                                    {sub.actualAmount > 0 ? sub.actualAmount.toLocaleString() : "無庫存"}
                                                </td>
                                                <td className="p-2 bg-white text-slate-600">
                                                    {isUnapplied && sub.actualAmount > 0 ? (
                                                        <span className="text-red-500 font-bold">未申請</span>
                                                    ) : (
                                                        sub.actualAmount === 0 ? "無庫存" : (isExcess ? sub.excess.toFixed(2) : "符合")
                                                    )}
                                                </td>
                                                <td className={`p-2 font-bold border-r border-slate-200 ${isExcess || (isUnapplied && sub.actualAmount > 0) ? 'bg-red-50 text-red-600' : 'bg-white text-emerald-600'}`}>
                                                    {isUnapplied && sub.actualAmount > 0 ? "超量" : (sub.actualAmount === 0 ? "無庫存" : (isExcess ? "超量" : "符合"))}
                                                </td>

                                                {isFirst && (
                                                    <td rowSpan={typeGroup.subRows.length} className="p-2 bg-white align-middle border-l border-slate-300">
                                                        <div className="flex flex-col items-center justify-center h-full">
                                                            <span className="text-sm text-slate-500 mb-2">比值</span>
                                                            <span className={`text-2xl font-extrabold ${isTypeOverLimit ? 'text-red-500' : 'text-emerald-600'}`}>
                                                                {typeGroup.totalComplianceRatio === Infinity ? "∞" : typeGroup.totalComplianceRatio.toFixed(2)}
                                                            </span>
                                                            {isTypeOverLimit ? (
                                                                <div className="mt-2 bg-red-50 text-red-600 px-2 py-1 rounded text-xs font-bold border border-red-200">
                                                                    超標
                                                                </div>
                                                            ) : (
                                                                <div className="mt-2 bg-emerald-50 text-emerald-600 px-2 py-1 rounded text-xs font-bold border border-emerald-200">
                                                                    符合
                                                                </div>
                                                            )}
                                                        </div>
                                                    </td>
                                                )}
                                            </tr>
                                        );
                                    });
                                })}
                            </tbody>
                        </table>
                    </div>
                </div>
            );
        };

        const ComplianceTables = ({ data }) => {
            const warehouseData = data.filter(r => r.location === '危險品庫房');
            const l30Data = data.filter(r => ['C4原膠室', 'P1原膠室'].includes(r.location));

            return (
                <div className="grid grid-cols-1 gap-6">
                    {warehouseData.length > 0 && (
                        <ZoneComplianceTable 
                            title="危險品庫房" 
                            records={warehouseData} 
                            config={WAREHOUSE_STATS_CONFIG} 
                        />
                    )}
                    {l30Data.length > 0 && (
                        <ZoneComplianceTable 
                            title="L30原膠室(C4原膠室+P1原膠室)" 
                            records={l30Data} 
                            config={L30_STATS_CONFIG} 
                        />
                    )}
                    {data.length === 0 && (
                        <div className="mt-6 p-4 text-center text-slate-400 bg-slate-100 rounded-lg">
                            無資料可進行管制量檢核
                        </div>
                    )}
                </div>
            );
        };

        const LocationDataList = ({ title, records, onEdit, onDelete }) => {
            const zoneStats = useMemo(() => {
                 const actualsMap = {};
                 records.forEach(r => {
                     const key = `${r.type}_${r.labelCategory}`;
                     if (!actualsMap[key]) actualsMap[key] = 0;
                     actualsMap[key] += r.amount;
                 });
                 let totalRatio = 0;
                 let totalAmount = 0;
                 const config = title.includes('危險品庫房') ? WAREHOUSE_STATS_CONFIG : L30_STATS_CONFIG;
                 config.forEach(typeGroup => {
                     typeGroup.items.forEach(item => {
                        const statLimit = item.statLimit; 
                        const lookupKey = `${typeGroup.type}_${item.name}`;
                        const actualAmount = actualsMap[lookupKey] || 0;
                        const ratio = statLimit > 0 ? (actualAmount / statLimit) : 0;
                        totalRatio += ratio;
                    });
                 });
                 totalAmount = records.reduce((sum, r) => sum + r.amount, 0);
                 return { totalRatio, totalAmount };
            }, [records, title]);

            return (
                <div className="bg-white rounded-xl shadow-lg overflow-hidden border border-slate-200 mb-6">
                    <div className="bg-slate-50 px-4 py-3 border-b border-slate-200 flex justify-between items-center flex-wrap gap-2">
                        <h3 className="text-lg font-bold text-slate-700 flex items-center gap-2">
                            <Database size={20} className="text-blue-500" />
                            {title}
                            <span className="text-sm font-normal text-slate-500 ml-2">
                                (共 {records.length} 筆)
                            </span>
                        </h3>
                        <div className="flex items-center gap-3 text-sm">
                            <div className="px-3 py-1 rounded bg-white border border-slate-300 shadow-sm">
                                <span className="text-slate-500 mr-1">倍數:</span>
                                <span className={`font-bold ${zoneStats.totalRatio >= 30 ? 'text-red-600' : 'text-blue-600'}`}>
                                    {zoneStats.totalRatio.toFixed(2)}
                                </span>
                            </div>
                            <div className="px-3 py-1 rounded bg-white border border-slate-300 shadow-sm">
                                <span className="text-slate-500 mr-1">儲存量:</span>
                                <span className="font-bold text-blue-600">
                                    {zoneStats.totalAmount.toFixed(2)}
                                </span>
                            </div>
                        </div>
                    </div>
                    <div className="overflow-x-auto">
                        <table className="w-full text-left border-collapse min-w-[1000px]">
                            <thead>
                                <tr className="bg-slate-100 border-b border-slate-200 text-slate-600 text-sm">
                                    <th className="p-3 font-semibold min-w-[100px] text-center">日期</th>
                                    <th className="p-3 font-semibold min-w-[120px] text-center">儲存場所</th>
                                    <th className="p-3 font-semibold whitespace-nowrap text-center">標示版歸類</th>
                                    <th className="p-3 font-semibold w-48 text-center">化學品名稱</th>
                                    <th className="p-3 font-semibold whitespace-nowrap text-center">料號</th>
                                    <th className="p-3 font-semibold min-w-[140px] text-center">危物分類</th>
                                    <th className="p-3 font-semibold min-w-[120px] text-center">種類</th>
                                    <th className="p-3 font-semibold whitespace-nowrap text-center">水溶性</th>
                                    <th className="p-3 font-semibold whitespace-nowrap text-center">管制量(L)</th>
                                    <th className="p-3 font-semibold whitespace-nowrap text-center">閃火點</th>
                                    <th className="p-3 font-semibold whitespace-nowrap text-center">儲存量</th>
                                    <th className="p-3 font-semibold whitespace-nowrap text-center">倍數</th>
                                    <th className="p-3 font-semibold text-center" style={{width: "120px"}}>操作</th>
                                </tr>
                            </thead>
                            <tbody className="divide-y divide-slate-100 text-sm">
                                {records.map((record) => (
                                    <tr key={record.id} className="hover:bg-slate-50 transition-colors">
                                        <td className="p-3 text-slate-700 text-center">{record.date}</td>
                                        <td className="p-3 text-slate-700 text-center font-medium">{record.location}</td>
                                        <td className="p-3 text-slate-700 font-medium text-center">{record.labelCategory}</td>
                                        <td className="p-3 text-slate-800 font-bold text-center">{record.chemical}</td>
                                        <td className="p-3 text-slate-500 font-mono text-xs text-center">{record.partNo}</td>
                                        <td className="p-3 text-slate-700 text-center">{record.hazard}</td>
                                        <td className="p-3 text-slate-700 text-center">
                                            <span className={`px-2 py-1 rounded-full text-xs border ${
                                                record.type.includes('第一石油類') ? 'bg-red-50 border-red-200 text-red-700' : 
                                                record.type.includes('第二石油類') ? 'bg-orange-50 border-orange-200 text-orange-700' : 
                                                'bg-gray-50 border-gray-200 text-gray-700'
                                            }`}>{record.type}</span>
                                        </td>
                                        <td className="p-3 text-slate-700 text-center">{record.solubility}</td>
                                        <td className="p-3 text-slate-700 text-center">{record.limit}</td>
                                        <td className="p-3 text-slate-700 text-center">{record.flashPoint}</td>
                                        <td className="p-3 text-center text-slate-800 font-bold">{record.amount}</td>
                                        <td className="p-3 text-slate-800 font-bold text-center">{record.limit ? (record.amount / record.limit).toFixed(2) : "0.00"}</td>
                                        <td className="p-3 text-center">
                                            <div className="flex justify-center gap-2">
                                                <button onClick={() => onEdit(record)} className="text-blue-500 hover:text-blue-700 hover:bg-blue-50 p-2 rounded-full transition-colors" title="修改"><Edit size={16} /></button>
                                                <button onClick={() => onDelete(record.id)} className="text-red-400 hover:text-red-600 hover:bg-red-50 p-2 rounded-full transition-colors" title="刪除"><Trash2 size={16} /></button>
                                            </div>
                                        </td>
                                    </tr>
                                ))}
                            </tbody>
                        </table>
                    </div>
                </div>
            );
        };

        const App = () => {
            const [records, setRecords] = useState([]);
            const [formData, setFormData] = useState({ date: new Date().toISOString().split('T')[0], chemical: '', location: '', amount: '' });
            
            // Move currentDetails definition up here, right after state init
            const currentDetails = useMemo(() => {
                return CHEMICAL_DB[formData.chemical] || null;
            }, [formData.chemical]);

            const [isFirebaseMode, setIsFirebaseMode] = useState(false); 
            const [editId, setEditId] = useState(null);
            const [isChemicalListOpen, setIsChemicalListOpen] = useState(false);

            // Admin State
            const [isAdmin, setIsAdmin] = useState(false);
            const [showLoginModal, setShowLoginModal] = useState(false);
            const [loginUser, setLoginUser] = useState('');
            const [loginPass, setLoginPass] = useState('');

            const fileInputRef = useRef(null); 
            const [filterStartDate, setFilterStartDate] = useState('');
            const [filterEndDate, setFilterEndDate] = useState('');
            const [filterChemical, setFilterChemical] = useState(''); 
            const [filterLocation, setFilterLocation] = useState('');
            const [filterLabelCategory, setFilterLabelCategory] = useState('');
            const [filterHazard, setFilterHazard] = useState('');
            const [user, setUser] = useState(null);
            const [notification, setNotification] = useState(null);
            const [deleteModal, setDeleteModal] = useState({ isOpen: false, targetId: null });

            // ... (useEffect for initData, Firebase, LocalStorage remain same)
            useEffect(() => {
                const initData = async () => {
                    if (window.firebaseServices) {
                        setIsFirebaseMode(true);
                        const { auth, signInAnonymously, onAuthStateChanged, signInWithCustomToken, initialToken } = window.firebaseServices;
                        try { if (initialToken) { await signInWithCustomToken(auth, initialToken); } else { await signInAnonymously(auth); } onAuthStateChanged(auth, (u) => { setUser(u); }); } catch (err) { console.error("Auth Error:", err); }
                    } else {
                        const saved = localStorage.getItem('chemical_records');
                        if (saved) { setRecords(JSON.parse(saved)); }
                    }
                };
                initData();
            }, []);

            useEffect(() => {
                if (user && window.firebaseServices) {
                    const { db, collection, onSnapshot, appId, query, orderBy } = window.firebaseServices;
                    const q = query(collection(db, 'artifacts', appId, 'users', user.uid, 'records'));
                    const unsubscribe = onSnapshot(q, (snapshot) => {
                        const remoteRecords = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                        remoteRecords.sort((a, b) => new Date(b.date) - new Date(a.date));
                        setRecords(remoteRecords);
                    }, (error) => { console.error("Snapshot error:", error); showNotification("讀取資料發生錯誤", "error"); });
                    return () => unsubscribe();
                }
            }, [user]);

            useEffect(() => { if (!window.firebaseServices) { localStorage.setItem('chemical_records', JSON.stringify(records)); } }, [records]);

            const showNotification = (message, type = 'success') => { setNotification({ message, type }); setTimeout(() => setNotification(null), 3000); };
            const handleInputChange = (e) => { const { name, value } = e.target; setFormData(prev => ({ ...prev, [name]: value })); };
            
            // Admin Login Logic
            const handleLogin = (e) => {
                e.preventDefault();
                if (loginUser === 'BML' && loginPass === 'BML23112569') {
                    setIsAdmin(true);
                    setShowLoginModal(false);
                    setLoginUser('');
                    setLoginPass('');
                    showNotification("管理員登入成功", "success");
                } else {
                    showNotification("帳號或密碼錯誤", "error");
                }
            };

            const handleLogout = () => {
                setIsAdmin(false);
                showNotification("已登出管理員模式", "success");
            };

            const handleAddRecord = async (e) => {
                e.preventDefault();
                if (!formData.chemical || !formData.amount || !formData.date || !formData.location) { showNotification("請填寫所有欄位 (包含儲存場所)！", "error"); return; }
                const details = CHEMICAL_DB[formData.chemical] || { labelCategory: "", partNo: "", hazard: "", type: "", solubility: "", limit: 0, flashPoint: 0 };
                const recordData = { ...formData, amount: parseFloat(formData.amount), ...details, timestamp: Date.now() };
                if (editId) {
                    if (isFirebaseMode && user) {
                        const { db, doc, updateDoc, appId } = window.firebaseServices;
                        try { const recordRef = doc(db, 'artifacts', appId, 'users', user.uid, 'records', editId); await updateDoc(recordRef, recordData); showNotification("資料修改成功 (雲端)！", "success"); } catch (err) { console.error("Update Error", err); showNotification("修改失敗", "error"); }
                    } else { setRecords(prev => prev.map(r => r.id === editId ? { ...recordData, id: editId } : r)); showNotification("資料修改成功 (本機)！", "success"); }
                    setEditId(null);
                } else {
                    if (isFirebaseMode && user) {
                        const { db, collection, addDoc, appId } = window.firebaseServices;
                        try { await addDoc(collection(db, 'artifacts', appId, 'users', user.uid, 'records'), recordData); showNotification("資料新增成功 (雲端)！", "success"); } catch (err) { console.error("Add Error", err); showNotification("新增失敗", "error"); }
                    } else { const newRecord = { id: Date.now(), ...recordData }; setRecords(prev => [newRecord, ...prev]); showNotification("資料新增成功 (本機)！", "success"); }
                }
                if (editId) { setFormData({ date: new Date().toISOString().split('T')[0], chemical: '', location: '', amount: '' }); } else { setFormData(prev => ({ ...prev, chemical: '', amount: '' })); }
            };
            const handleEdit = (record) => { setFormData({ date: record.date, chemical: record.chemical, location: record.location, amount: record.amount }); setEditId(record.id); window.scrollTo({ top: 0, behavior: 'smooth' }); showNotification("已載入資料，請在左側表單修改", "success"); };
            const handleCancelEdit = () => { setEditId(null); setFormData({ date: new Date().toISOString().split('T')[0], chemical: '', location: '', amount: '' }); showNotification("已取消修改", "success"); };
            const initiateDelete = (id) => { setDeleteModal({ isOpen: true, targetId: id }); };
            const confirmDelete = async () => {
                if (deleteModal.targetId) {
                    if (editId === deleteModal.targetId) { handleCancelEdit(); }
                    if (isFirebaseMode && user) {
                        const { db, doc, deleteDoc, appId } = window.firebaseServices;
                        try { await deleteDoc(doc(db, 'artifacts', appId, 'users', user.uid, 'records', deleteModal.targetId)); showNotification("資料已刪除 (雲端)", "success"); } catch (err) { console.error("Delete Error", err); showNotification("刪除失敗", "error"); }
                    } else { setRecords(records.filter(r => r.id !== deleteModal.targetId)); showNotification("資料已刪除 (本機)", "success"); }
                }
                setDeleteModal({ isOpen: false, targetId: null });
            };
            const cancelDelete = () => { setDeleteModal({ isOpen: false, targetId: null }); };
            const handleImportClick = () => { fileInputRef.current.click(); };
            const handleFileChange = (e) => { 
                const file = e.target.files[0];
                if (!file) return;
                const reader = new FileReader();
                reader.onload = async (event) => {
                    const text = event.target.result;
                    const content = text.startsWith('\uFEFF') ? text.slice(1) : text;
                    const lines = content.split(/\r?\n/).filter(line => line.trim() !== '');
                    let successCount = 0;
                    let failCount = 0;
                    const newRecords = [];
                    for (let i = 1; i < lines.length; i++) {
                        const line = lines[i];
                        const parts = [];
                        let current = '';
                        let inQuote = false;
                        for (let j = 0; j < line.length; j++) { const char = line[j]; if (char === '"') { inQuote = !inQuote; } else if (char === ',' && !inQuote) { parts.push(current.trim()); current = ''; } else { current += char; } }
                        parts.push(current.trim());
                        const cleanParts = parts.map(p => p.replace(/^"|"$/g, ''));
                        if (cleanParts.length >= 11) {
                            const date = cleanParts[0];
                            const location = cleanParts[1];
                            const chemical = cleanParts[2];
                            const amount = parseFloat(cleanParts[10]);
                            if (date && location && chemical && !isNaN(amount)) {
                                const details = CHEMICAL_DB[chemical] || { labelCategory: cleanParts[3] || "", partNo: cleanParts[4] || "", hazard: cleanParts[5] || "", type: cleanParts[6] || "", solubility: cleanParts[7] || "", limit: parseFloat(cleanParts[8]) || 0, flashPoint: parseFloat(cleanParts[9]) || 0 };
                                const recordData = { date, location, chemical, amount, ...details, timestamp: Date.now() + i };
                                newRecords.push(recordData);
                                successCount++;
                            } else { failCount++; }
                        }
                    }
                    if (newRecords.length > 0) {
                        if (isFirebaseMode && user) {
                            const { db, collection, addDoc, appId } = window.firebaseServices;
                            const colRef = collection(db, 'artifacts', appId, 'users', user.uid, 'records');
                            for (const rec of newRecords) { await addDoc(colRef, rec); }
                            showNotification(`成功匯入 ${successCount} 筆資料至雲端`, "success");
                        } else {
                            const localImport = newRecords.map(r => ({...r, id: r.timestamp}));
                            setRecords(prev => [...localImport, ...prev]);
                            showNotification(`成功匯入 ${successCount} 筆資料至本機`, "success");
                        }
                    } else { showNotification("未找到有效資料或格式錯誤", "error"); }
                    e.target.value = '';
                };
                reader.readAsText(file);
            };

            const uniqueLabelCategories = useMemo(() => [...new Set(Object.values(CHEMICAL_DB).map(c => c.labelCategory))].sort(), []);
            const uniqueHazards = useMemo(() => [...new Set(Object.values(CHEMICAL_DB).map(c => c.hazard))].sort(), []);

            const filteredRecords = useMemo(() => {
                return records.filter(record => {
                    const isAfterStart = !filterStartDate || record.date >= filterStartDate;
                    const isBeforeEnd = !filterEndDate || record.date <= filterEndDate;
                    const isChemicalMatch = !filterChemical || record.chemical.toLowerCase().includes(filterChemical.toLowerCase());
                    const isLocationMatch = !filterLocation || record.location === filterLocation; 
                    const isLabelMatch = !filterLabelCategory || record.labelCategory.toLowerCase().includes(filterLabelCategory.toLowerCase());
                    const isHazardMatch = !filterHazard || record.hazard === filterHazard;
                    return isAfterStart && isBeforeEnd && isChemicalMatch && isLocationMatch && isLabelMatch && isHazardMatch;
                });
            }, [records, filterStartDate, filterEndDate, filterChemical, filterLocation, filterLabelCategory, filterHazard]);

            const handleExport = () => { /* ... Export logic ... */ 
                if (filteredRecords.length === 0) { showNotification("沒有資料可以匯出！", "error"); return; }
                const bom = "\uFEFF";
                const headers = "日期,儲存場所,化學品名稱,標示版歸類,料號,危物分類,種類(公式),水溶性,管制量(L),閃火點,儲存量(kg/L),倍數\n";
                const csvContent = filteredRecords.map(r => { const ratio = r.limit ? (r.amount / r.limit).toFixed(2) : "0.00"; return `${r.date},"${r.location}","${r.chemical}","${r.labelCategory}","${r.partNo}","${r.hazard}","${r.type}","${r.solubility}",${r.limit},${r.flashPoint},${r.amount},${ratio}`; }).join("\n");
                const blob = new Blob([bom + headers + csvContent], { type: 'text/csv;charset=utf-8;' });
                const url = URL.createObjectURL(blob);
                const link = document.createElement("a");
                link.href = url;
                let filename = "公共危險物品庫存表.csv";
                link.setAttribute("download", filename);
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                showNotification("匯出成功！", "success");
            };

            const clearFilters = () => { setFilterStartDate(''); setFilterEndDate(''); setFilterChemical(''); setFilterLocation(''); setFilterLabelCategory(''); setFilterHazard(''); };

            const warehouseRecords = useMemo(() => filteredRecords.filter(r => r.location === '危險品庫房'), [filteredRecords]);
            const l30Records = useMemo(() => filteredRecords.filter(r => ['C4原膠室', 'P1原膠室'].includes(r.location)), [filteredRecords]);
            
            // Calculate totals for summary header (if needed above list, but list is now at bottom)
            // We can keep the zoneMultiples logic if we want to display it somewhere else or just let components handle it.
            const zoneMultiples = useMemo(() => {
                const calc = (recs, cfg) => { /* ... simplified for brevity ... */ return 0; }; // Placeholder if not used in top summary
                return { warehouse: 0, l30: 0 }; 
            }, [filteredRecords]);

             const totalAmounts = useMemo(() => {
                const warehouse = warehouseRecords.reduce((sum, r) => sum + (Number(r.amount) || 0), 0);
                const l30 = l30Records.reduce((sum, r) => sum + (Number(r.amount) || 0), 0);
                return { warehouse, l30 };
            }, [warehouseRecords, l30Records]);


            return (
                <div className="min-h-screen bg-slate-50 p-4 md:p-8 font-sans relative">
                    {/* ... Modals & Notifications ... */}
                    {notification && (<div className={`fixed bottom-6 right-6 px-6 py-4 rounded-lg shadow-xl flex items-center gap-3 z-50 animate-bounce-in text-white font-medium ${notification.type === 'error' ? 'bg-red-500' : 'bg-emerald-600'}`}>{notification.type === 'error' ? <AlertCircle size={24} /> : <CheckCircle size={24} />}{notification.message}</div>)}
                    <input type="file" ref={fileInputRef} className="hidden" accept=".csv" onChange={handleFileChange} />
                    
                     {/* Storage Mode Indicator */}
                    <div className="fixed top-4 right-4 z-50 flex gap-2">
                        <span className={`px-3 py-1 rounded-full text-xs font-bold shadow-md border ${isFirebaseMode ? 'bg-blue-100 text-blue-800 border-blue-200' : 'bg-orange-100 text-orange-800 border-orange-200'}`}>
                            {isFirebaseMode ? (<span className="flex items-center gap-1"><Cloud size={14} /> 雲端資料庫</span>) : (<span className="flex items-center gap-1"><Database size={14} /> 本機儲存</span>)}
                        </span>
                        
                        {/* Admin Login/Logout Button */}
                        {isAdmin ? (
                             <button onClick={handleLogout} className="px-3 py-1 rounded-full text-xs font-bold shadow-md border bg-slate-800 text-white border-slate-700 flex items-center gap-1 hover:bg-slate-700 transition-colors">
                                <Unlock size={14} /> 管理員登出
                             </button>
                        ) : (
                             <button onClick={() => setShowLoginModal(true)} className="px-3 py-1 rounded-full text-xs font-bold shadow-md border bg-white text-slate-600 border-slate-300 flex items-center gap-1 hover:bg-slate-50 transition-colors">
                                <Lock size={14} /> 管理員登入
                             </button>
                        )}
                    </div>
                     {/* Delete Confirmation Modal */}
                    {deleteModal.isOpen && (
                        <div className="fixed inset-0 bg-black/50 backdrop-blur-sm flex items-center justify-center z-50">
                            <div className="bg-white rounded-xl shadow-2xl p-6 w-full max-w-sm mx-4 animate-scale-up">
                                <div className="flex flex-col items-center text-center">
                                    <div className="bg-red-100 p-3 rounded-full mb-4">
                                        <AlertTriangle className="text-red-600" size={32} />
                                    </div>
                                    <h3 className="text-xl font-bold text-slate-800 mb-2">確定刪除資料？</h3>
                                    <p className="text-slate-500 mb-6">此動作無法復原，您確定要刪除這筆紀錄嗎？</p>
                                    <div className="flex gap-3 w-full">
                                        <button 
                                            onClick={cancelDelete}
                                            className="flex-1 px-4 py-2 bg-slate-100 text-slate-700 font-semibold rounded-lg hover:bg-slate-200 transition-colors"
                                        >
                                            取消
                                        </button>
                                        <button 
                                            onClick={confirmDelete}
                                            className="flex-1 px-4 py-2 bg-red-600 text-white font-semibold rounded-lg hover:bg-red-700 transition-colors shadow-lg shadow-red-200"
                                        >
                                            確定刪除
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    )}
                    
                     {/* Admin Login Modal */}
                    {showLoginModal && (
                        <div className="fixed inset-0 bg-black/50 backdrop-blur-sm flex items-center justify-center z-50">
                            <div className="bg-white rounded-xl shadow-2xl p-8 w-full max-w-sm mx-4 animate-scale-up border border-slate-100">
                                <h2 className="text-2xl font-bold text-slate-800 mb-6 text-center">管理員登入</h2>
                                <form onSubmit={handleLogin} className="space-y-4">
                                    <div>
                                        <label className="block text-sm font-medium text-slate-600 mb-1">帳號</label>
                                        <input type="text" value={loginUser} onChange={(e) => setLoginUser(e.target.value)} className="w-full p-2 border border-slate-300 rounded focus:ring-2 focus:ring-blue-500" required />
                                    </div>
                                    <div>
                                        <label className="block text-sm font-medium text-slate-600 mb-1">密碼</label>
                                        <input type="password" value={loginPass} onChange={(e) => setLoginPass(e.target.value)} className="w-full p-2 border border-slate-300 rounded focus:ring-2 focus:ring-blue-500" required />
                                    </div>
                                    <div className="flex gap-3 pt-2">
                                        <button type="button" onClick={() => setShowLoginModal(false)} className="flex-1 px-4 py-2 bg-slate-100 text-slate-700 rounded hover:bg-slate-200">取消</button>
                                        <button type="submit" className="flex-1 px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700">登入</button>
                                    </div>
                                </form>
                            </div>
                        </div>
                    )}


                    <div className="max-w-[1600px] mx-auto">
                        <header className="mb-8 text-center md:text-left">
                             <div className="flex items-center justify-center md:justify-start gap-3">
                                <img 
                                    src="https://upload.wikimedia.org/wikipedia/commons/thumb/f/f3/BenQ_logo.svg/200px-BenQ_logo.svg.png" 
                                    alt="BenQ Logo" 
                                    className="h-12 w-auto mr-4 object-contain"
                                    onError={(e) => {
                                        e.target.onerror = null; 
                                        e.target.src = "https://www.benq.com/content/dam/b2c/en/logos/benq-logo.png"; 
                                    }}
                                />
                                <div>
                                    <h1 className="text-3xl font-bold text-slate-800 flex items-center gap-3">
                                        <FileSpreadsheet className="text-blue-500" size={32} />
                                        龍科廠-公共危險物品儲存量管理系統
                                    </h1>
                                    <p className="text-slate-500 mt-2">庫存管理與資料記錄</p>
                                </div>
                            </div>
                        </header>

                        <div className="grid grid-cols-1 xl:grid-cols-5 gap-8">
                            
                            {/* 左側：輸入表單區 (佔 1/5) */}
                            <div className="xl:col-span-1 space-y-6">
                                {/* Form ... */}
                                <div className={`bg-white rounded-xl shadow-lg p-6 border ${editId ? 'border-blue-500 ring-2 ring-blue-100' : 'border-slate-200'}`}>
                                    <h2 className="text-xl font-semibold mb-4 text-slate-700 flex items-center gap-2">
                                        {editId ? <Edit size={20} className="text-blue-500" /> : <PlusCircle size={20} />}
                                        {editId ? '修改資料' : '資料輸入'}
                                    </h2>
                                    
                                    <form onSubmit={handleAddRecord} className="space-y-4">
                                        {/* Inputs same as before, condensed for brevity */}
                                        <div><label className="block text-sm font-medium text-slate-600 mb-1">日期</label><input type="date" name="date" value={formData.date} onChange={handleInputChange} className="w-full p-2 text-sm border border-slate-300 rounded-lg" required /></div>
                                        <div><label className="block text-sm font-medium text-slate-600 mb-1">儲存場所</label><div className="relative"><MapPin className="absolute left-3 top-2.5 text-slate-400" size={18} /><select name="location" value={formData.location} onChange={handleInputChange} className="w-full p-2 pl-10 text-sm border border-slate-300 rounded-lg bg-white" required><option value="">-- 請選擇儲存場所 --</option>{STORAGE_LOCATIONS.map((loc, index) => (<option key={index} value={loc}>{loc}</option>))}</select></div></div>
                                        <div><label className="block text-sm font-medium text-slate-600 mb-1">化學品名稱</label><div className="relative"><Search className="absolute left-3 top-2.5 text-slate-400" size={18} /><input type="text" name="chemical" value={formData.chemical} onChange={(e) => { handleInputChange(e); setIsChemicalListOpen(true); }} onFocus={() => setIsChemicalListOpen(true)} onBlur={() => setTimeout(() => setIsChemicalListOpen(false), 200)} placeholder="搜尋..." className="w-full p-2 pl-10 text-sm border border-slate-300 rounded-lg" autoComplete="off" /><button type="button" onClick={() => setIsChemicalListOpen(!isChemicalListOpen)} className="absolute right-2 top-2.5 text-slate-400"><ChevronDown size={16} /></button>{isChemicalListOpen && (<ul className="absolute z-10 w-full bg-white border border-slate-300 rounded-lg shadow-lg max-h-60 overflow-y-auto mt-1">{CHEMICAL_LIST.filter(c => c.toLowerCase().includes(formData.chemical.toLowerCase())).map(c => (<li key={c} className="p-2 text-sm hover:bg-blue-50 cursor-pointer" onMouseDown={() => { setFormData(prev => ({ ...prev, chemical: c })); setIsChemicalListOpen(false); }}>{c}</li>))}</ul>)}</div></div>
                                        {currentDetails && (<div className="bg-sky-50 p-3 rounded-lg text-xs space-y-1 border border-sky-100 text-sky-800"><p><strong>分類:</strong> {currentDetails.labelCategory}</p><p><strong>危物:</strong> {currentDetails.hazard}</p><p><strong>管制量:</strong> {currentDetails.limit} L</p></div>)}
                                        <div><label className="block text-sm font-medium text-slate-600 mb-1">儲存量 (kg/L)</label><input type="number" step="0.01" name="amount" value={formData.amount} onChange={handleInputChange} placeholder="輸入..." className="w-full p-2 text-sm border border-slate-300 rounded-lg" required /></div>
                                        <div className="flex gap-2">{editId && (<button type="button" onClick={handleCancelEdit} className="w-1/3 bg-slate-200 hover:bg-slate-300 text-slate-700 font-bold py-3 px-4 rounded-lg">取消</button>)}<button type="submit" className={`flex-1 ${editId ? 'bg-blue-600' : 'bg-blue-500 hover:bg-blue-600'} text-white font-bold py-3 px-4 rounded-lg`}>{editId ? '確認修改' : '儲存資料'}</button></div>
                                    </form>
                                </div>

                                {/* 注意事項 */}
                                <div className="bg-red-50 border-4 border-red-500 p-6 shadow-lg rounded-xl transform transition-transform hover:scale-105">
                                    <h4 className="text-xl font-extrabold text-red-700 mb-4 flex items-center gap-2 border-b-2 border-red-200 pb-2"><AlertTriangle size={28} className="text-red-600 animate-pulse" /> 注意事項</h4>
                                    <ol className="text-lg font-bold text-red-800 list-decimal list-inside space-y-3">
                                        <li>請於每周五15:00前完成資料輸入</li>
                                        <li>請依現場實際儲存量盤點(含廢膠)</li>
                                    </ol>
                                </div>
                            </div>

                            {/* 右側：顯示與操作區 (佔 4/5) */}
                            <div className="xl:col-span-4 space-y-6 flex flex-col">
                                
                                {/* 1. 資料篩選工具 (Moved to Top Right) */}
                                <div className="bg-white rounded-xl shadow-sm p-5 border border-slate-200 order-1">
                                    <div className="flex flex-col gap-4">
                                        <div className="flex justify-between items-center">
                                            <div className="flex items-center gap-2 text-slate-700 font-semibold"><Filter size={20} className="text-blue-500" />資料篩選</div>
                                            <div className="flex gap-2">
                                                {isAdmin && (<button onClick={handleImportClick} className="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-lg flex items-center gap-2 text-sm font-medium"><Upload size={18} /> 匯入 Excel (CSV)</button>)}
                                                <button onClick={handleExport} className="bg-emerald-500 hover:bg-emerald-600 text-white px-4 py-2 rounded-lg flex items-center gap-2 text-sm font-medium"><Download size={18} /> 匯出 Excel (CSV)</button>
                                            </div>
                                        </div>
                                        <hr className="border-slate-100" />
                                        {/* Horizontal Layout for Filters */}
                                        <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 xl:grid-cols-6 gap-4">
                                            <div className="flex flex-col gap-1 col-span-1 md:col-span-2 lg:col-span-2 xl:col-span-2"><div className="flex items-center gap-2"><CalendarIcon size={16} className="text-slate-400" /><span className="text-sm text-slate-500 font-medium">日期區間:</span></div><div className="flex items-center gap-2"><input type="date" value={filterStartDate} onChange={(e) => setFilterStartDate(e.target.value)} className="bg-white border border-slate-300 rounded px-2 py-2 text-sm w-full focus:ring-2 focus:ring-blue-500 outline-none" /><span className="text-slate-400 text-xs">~</span><input type="date" value={filterEndDate} onChange={(e) => setFilterEndDate(e.target.value)} className="bg-white border border-slate-300 rounded px-2 py-2 text-sm w-full focus:ring-2 focus:ring-blue-500 outline-none" /></div></div>
                                            <div className="w-full col-span-1"><div className="flex items-center gap-2 mb-1"><MapPin size={16} className="text-slate-400" /><span className="text-sm text-slate-500 font-medium">儲存場所:</span></div><select value={filterLocation} onChange={(e) => setFilterLocation(e.target.value)} className="bg-white border border-slate-300 rounded p-2 text-sm w-full focus:ring-2 focus:ring-blue-500 outline-none"><option value="">全部場所</option>{STORAGE_LOCATIONS.map(loc => <option key={loc} value={loc}>{loc}</option>)}</select></div>
                                            <div className="w-full col-span-1"><div className="flex items-center gap-2 mb-1"><Tag size={16} className="text-slate-400" /><span className="text-sm text-slate-500 font-medium">標示版歸類:</span></div><SearchableSelect value={filterLabelCategory} onChange={setFilterLabelCategory} options={uniqueLabelCategories} placeholder="搜尋歸類..." icon={null} /></div>
                                            <div className="w-full col-span-1"><div className="flex items-center gap-2 mb-1"><ShieldAlert size={16} className="text-slate-400" /><span className="text-sm text-slate-500 font-medium">危物分類:</span></div><select value={filterHazard} onChange={(e) => setFilterHazard(e.target.value)} className="bg-white border border-slate-300 rounded p-2 text-sm w-full focus:ring-2 focus:ring-blue-500 outline-none"><option value="">全部危物</option>{uniqueHazards.map(h => <option key={h} value={h}>{h}</option>)}</select></div>
                                            <div className="w-full col-span-1"><div className="flex items-center gap-2 mb-1"><Search size={16} className="text-slate-400" /><span className="text-sm text-slate-500 font-medium">化學品名稱:</span></div><SearchableSelect value={filterChemical} onChange={setFilterChemical} options={CHEMICAL_LIST} placeholder="搜尋化學品..." icon={null} /></div>
                                            {(filterStartDate || filterEndDate || filterChemical || filterLocation || filterLabelCategory || filterHazard) && (<div className="flex items-end justify-end col-span-full xl:col-span-1"><button onClick={clearFilters} className="flex items-center justify-center gap-1 text-sm text-red-500 hover:text-red-700 hover:bg-red-50 px-4 py-2.5 rounded-lg transition-colors w-full border border-red-100 hover:border-red-200"><XIcon size={16} /> 清除篩選</button></div>)}
                                        </div>
                                    </div>
                                </div>

                                {/* 2. 合規檢查表格 */}
                                <div className="order-2">
                                    {filteredRecords.length > 0 && <ComplianceTables data={filteredRecords} />}
                                </div>

                                {/* 3. 趨勢圖 */}
                                <div className="space-y-6 order-3">
                                    {warehouseRecords.length > 0 && <TrendChart data={warehouseRecords} title="化學品儲存量趨勢 - 危險品庫房" />}
                                    {l30Records.length > 0 && <TrendChart data={l30Records} title="化學品儲存量趨勢 - L30原膠室(C4+P1)" />}
                                </div>

                                {/* 4. 化學品儲存量列表 (含標題) */}
                                <div className="order-4">
                                    {/* 資料統計標題 */}
                                    <div className="flex flex-col xl:flex-row justify-between items-end px-2 gap-4 mt-8 pt-6 border-t border-slate-200">
                                        <h3 className="text-lg font-bold text-slate-700 whitespace-nowrap">
                                            {(filterStartDate || filterEndDate || filterChemical || filterLocation) ? '篩選結果列表' : '化學品儲存量列表'} 
                                            <span className="text-sm font-normal text-slate-500 ml-2">
                                                (共 {filteredRecords.length} 筆)
                                            </span>
                                        </h3>
                                        <div className="flex flex-wrap items-center justify-end gap-2 text-sm font-medium text-slate-600">
                                            <div className="flex items-center gap-2 bg-orange-50 px-3 py-1 rounded border border-orange-200 shadow-sm">
                                                <span className="font-bold text-orange-800">危險品庫房</span>
                                                <span className="text-orange-300">|</span>
                                                <span>儲存量: <span className="text-blue-600 font-bold">{totalAmounts.warehouse.toFixed(2)}</span></span>
                                            </div>
                                            <div className="flex items-center gap-2 bg-sky-50 px-3 py-1 rounded border border-sky-200 shadow-sm">
                                                <span className="font-bold text-sky-800">L30原膠室</span>
                                                <span className="text-sky-300">|</span>
                                                <span>儲存量: <span className="text-blue-600 font-bold">{totalAmounts.l30.toFixed(2)}</span></span>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    {/* 列表內容 */}
                                    <div>
                                        {warehouseRecords.length > 0 && <LocationDataList title="危險品庫房 - 儲存量列表" records={warehouseRecords} onEdit={handleEdit} onDelete={initiateDelete} />}
                                        {l30Records.length > 0 && <LocationDataList title="L30原膠室(C4+P1) - 儲存量列表" records={l30Records} onEdit={handleEdit} onDelete={initiateDelete} />}
                                        {filteredRecords.length === 0 && (<div className="p-10 text-center text-slate-400 flex flex-col items-center justify-center bg-white rounded-xl border border-slate-200"><FileSpreadsheet size={48} className="mb-2 opacity-20" />尚無資料，請從左側新增。</div>)}
                                    </div>
                                </div>
                                
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>